---
import ChatMessage from "./ChatMessage.astro";

const { t, lang } = Astro.locals as any;
---

<section class="chat-card" data-lang={lang}>
  <header class="chat-header">
    <h2>{t.chat.title}</h2>
    <p>{t.chat.subtitle}</p>
  </header>

  <div class="chat-body">
    <ChatMessage role="assistant" content={t.chat.greeting} />

    <div class="badges">
      {
        t.chat.initialBadges.map((badge: string) => (
          <button class="badge">{badge}</button>
        ))
      }
    </div>
  </div>
</section>

<script>
  import { getChatReply } from "@/chat/client";

  function appendMessage(body: HTMLElement, role: "user" | "assistant", text: string) {
    const el = document.createElement("div");
    el.className = `msg ${role}`;
    el.textContent = text;
    body.appendChild(el);
  }

  function appendBadges(body: HTMLElement, followUps: string[]) {
    if (!followUps?.length) return;
    const badgesWrap = document.createElement("div");
    badgesWrap.className = "badges";

    followUps.forEach((q: string) => {
      const btn = document.createElement("button");
      btn.className = "badge";
      btn.type = "button";
      btn.textContent = q;
      badgesWrap.appendChild(btn);
    });

    body.appendChild(badgesWrap);
  }

  function initChat() {
    // Inicializar por instancia (widget + página assistant pueden coexistir)
    document.querySelectorAll(".chat-card").forEach((chatCardEl) => {
      const chatCard = chatCardEl as HTMLElement;
      const body = chatCard.querySelector(".chat-body") as HTMLElement | null;
      if (!body) return;

      // Evitar listeners duplicados si Astro re-ejecuta init (page transitions)
      if (body.dataset.chatBound === "1") return;
      body.dataset.chatBound = "1";

      const currentLang = (chatCard.getAttribute("data-lang") as ("es" | "en" | "pt") | null) ?? "es";

      body.addEventListener("click", (e) => {
        const target = e.target as HTMLElement | null;
        const btn = (target?.closest?.("button.badge") as HTMLButtonElement | null) ?? null;
        if (!btn) return;

        // limpiar badges anteriores (solo dentro de esta instancia)
        body.querySelectorAll(".badges").forEach((el) => el.remove());

        const message = btn.textContent?.trim();
        if (!message) return;

        appendMessage(body, "user", message);

        // Respuesta local (sin fetch) para que funcione en deploy estático
        const data = getChatReply(message, currentLang);

        appendMessage(body, "assistant", data.reply);
        appendBadges(body, data.followUps);

        body.scrollTop = body.scrollHeight;
      });
    });
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initChat);
  } else {
    initChat();
  }

  // Reinicializar en transiciones de Astro
  document.addEventListener("astro:page-load", initChat);
</script>
