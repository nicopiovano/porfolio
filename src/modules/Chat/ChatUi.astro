---
import ChatMessage from "./ChatMessage.astro"

const { t, lang } = Astro.locals
---

<section class="chat-card" data-lang={lang}>
  <header class="chat-header">
    <h2>{t.chat.title}</h2>
    <p>{t.chat.subtitle}</p>
  </header>

  <div class="chat-body" id="chat-body">
    <ChatMessage
      role="assistant"
      content={t.chat.greeting}
    />

    <div class="badges">
      {t.chat.initialBadges.map((badge: string) => (
        <button class="badge">{badge}</button>
      ))}
    </div>
  </div>
</section>

<script>
  const body = document.getElementById("chat-body")
  if (!body) return
  
  const chatCard = document.querySelector(".chat-card")
  const currentLang = chatCard?.getAttribute("data-lang") || "es"
  
  body.addEventListener("click", async (e: Event) => {
    const target = e.target as HTMLElement
    if (!target || !target.classList.contains("badge")) return

    // ðŸ”¥ limpiar badges anteriores
    body.querySelectorAll(".badges").forEach(el => el.remove())

    const message = target.textContent
    if (!message) return

    body.insertAdjacentHTML(
      "beforeend",
      `<div class="msg user">${message}</div>`
    )

    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, lang: currentLang })
    })

    const data = await res.json()

    body.insertAdjacentHTML(
      "beforeend",
      `<div class="msg assistant">${data.reply}</div>`
    )

    if (data.followUps?.length) {
      const badges = (data.followUps as string[])
        .map((q: string) => `<button class="badge">${q}</button>`)
        .join("")

      body.insertAdjacentHTML(
        "beforeend",
        `<div class="badges">${badges}</div>`
      )
    }

    body.scrollTop = body.scrollHeight
  })
</script>
