---
---

<div id="three-container" class="w-full h-full min-h-[400px] md:min-h-[500px] flex items-center justify-center"></div>

<script>
  async function initThreeScene() {
    // Verificar si es Firefox
    const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1
    
    // Si no es Firefox, ocultar el contenedor 3D
    // if (!isFirefox) {
    //   const container = document.getElementById('three-container')
    //   if (container) {
    //     container.style.display = 'none'
    //     // Mostrar mensaje alternativo
    //     container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400"><p>Los efectos 3D están deshabilitados.</p><p class="text-sm mt-2">Usa Firefox para ver la experiencia completa.</p></div>'
    //     container.style.display = 'flex'
    //   }
    //   return
    // }
    
    const THREE = await import('three')
    const { OrbitControls } = await import('three/examples/jsm/controls/OrbitControls.js')
    
    const container = document.getElementById('three-container')
    if (!container) return

    // Limpiar contenedor si ya tiene contenido
    while (container.firstChild) {
      container.removeChild(container.firstChild)
    }

    // Escena
    const scene = new THREE.Scene()
    
    // Cámara
    const camera = new THREE.PerspectiveCamera(
      75,
      container.clientWidth / container.clientHeight,
      0.1,
      1000
    )
    camera.position.z = 5

    // Renderer
    const renderer = new THREE.WebGLRenderer({ 
      alpha: true,
      antialias: true 
    })
    renderer.setSize(container.clientWidth, container.clientHeight)
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
    container.appendChild(renderer.domElement)

    // Controles de órbita para mover la figura
    const controls = new OrbitControls(camera, renderer.domElement)
    controls.enableDamping = true
    controls.dampingFactor = 0.05
    controls.enableZoom = false // Deshabilitar zoom para evitar que se agrande demasiado
    controls.enablePan = false
    controls.minDistance = 3 // Distancia mínima de la cámara
    controls.maxDistance = 3 // Distancia máxima de la cámara (mismo valor = sin zoom)
    
    // Geometría - TorusKnot (nudo toroidal)
    const geometry = new THREE.TorusGeometry(1, 0.5, 500, 100)
    
    // Material con color verde que se adapta al tema
    const isDark = document.documentElement.classList.contains('dark')
    const material = new THREE.MeshStandardMaterial({
      color: isDark ? 0x22c55e : 0x16a34a, // Verde más claro en light mode
      metalness: 0.3,
      roughness: 0.4,
      emissive: isDark ? 0x22c55e : 0x16a34a,
      emissiveIntensity: 0.2
    })

    const torusKnot = new THREE.Mesh(geometry, material)
    scene.add(torusKnot)

    // Luces
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6)
    scene.add(ambientLight)

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8)
    directionalLight.position.set(5, 5, 5)
    scene.add(directionalLight)

    const pointLight = new THREE.PointLight(isDark ? 0x22c55e : 0x16a34a, 0.5)
    pointLight.position.set(-5, -5, 5)
    scene.add(pointLight)

    // Animación
    function animate() {
      requestAnimationFrame(animate)

      // Actualizar controles
      controls.update()

      // Rotación automática solo si no está siendo controlado manualmente
      if (!controls.enabled || !controls.isDragging) {
        torusKnot.rotation.x += 0.01
        torusKnot.rotation.y += 0.01
      }

      renderer.render(scene, camera)
    }

    animate()

    // Resize handler
    function handleResize() {
      const width = container.clientWidth
      const height = container.clientHeight

      camera.aspect = width / height
      camera.updateProjectionMatrix()

      renderer.setSize(width, height)
    }

    window.addEventListener('resize', handleResize)

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize)
      controls.dispose()
      renderer.dispose()
      geometry.dispose()
      material.dispose()
    }
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThreeScene)
  } else {
    initThreeScene()
  }

  // Reinicializar en transiciones de Astro
  document.addEventListener('astro:page-load', initThreeScene)
</script>

<style>
  #three-container {
    position: relative;
  }

  #three-container canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
  }
</style>
