---
const { t } = Astro.locals as any;

const title = t.modeSelector?.title ?? "¿Qué estás buscando?";
const subtitle =
  t.modeSelector?.subtitle ??
  "Elegí una opción para ver la versión del portfolio más relevante.";

const employmentLabel = t.modeSelector?.employment ?? "Relación de dependencia";
const freelanceLabel = t.modeSelector?.freelance ?? "Proyectos (freelance)";
---

<div id="mode-selector" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label={title}>
    <h2 class="title">{title}</h2>
    <p class="subtitle">{subtitle}</p>

    <div class="actions">
      <button id="mode-employment" type="button" class="btn btn-secondary">
        {employmentLabel}
      </button>
      <button id="mode-freelance" type="button" class="btn btn-primary">
        {freelanceLabel}
      </button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const root = document.documentElement;

    const modal = document.getElementById("mode-selector");
    const btnEmployment = document.getElementById("mode-employment");
    const btnFreelance = document.getElementById("mode-freelance");

    if (!modal || !btnEmployment || !btnFreelance) return;

    const syncSectionIds = (mode) => {
      // Limpiar ids previos
      document.querySelectorAll("[data-section-key]").forEach((el) => {
        el.removeAttribute("id");
      });
      // Asignar ids solo al modo activo
      document
        .querySelectorAll(`[data-mode="${mode}"] [data-section-key]`)
        .forEach((el) => {
          const key = el.getAttribute("data-section-key");
          if (key) el.setAttribute("id", key);
        });
    };

    const applyMode = (mode) => {
      root.dataset.siteMode = mode;
      syncSectionIds(mode);
      window.dispatchEvent(new CustomEvent("site-mode:changed", { detail: { mode } }));
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    };

    const showModal = () => {
      root.dataset.siteMode = "unset";
      // sin modo seleccionado, no exponer ids para evitar conflictos
      document.querySelectorAll("[data-section-key]").forEach((el) => {
        el.removeAttribute("id");
      });
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    };

    btnEmployment.addEventListener("click", () => applyMode("employment"));
    btnFreelance.addEventListener("click", () => applyMode("freelance"));

    // Mostrar inmediatamente cuando termina el loading del intro loader
    window.addEventListener("intro-loader:done", showModal, { once: true });

    // Fallback: si por algún motivo el loader no corre, mostrar igual.
    document.addEventListener("astro:page-load", () => {
      if (root.dataset.siteMode === "unset" && root.dataset.introLoader !== "show") {
        showModal();
      }
    });
  })();
</script>

<style>
  #mode-selector {
    position: fixed;
    inset: 0;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: #000;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 200ms ease;
  }

  #mode-selector.is-open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .panel {
    width: 100%;
    max-width: 720px;
    border-radius: 28px;
    padding: 22px 20px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(10, 10, 10, 0.85);
    backdrop-filter: blur(10px);
    box-shadow: 0 22px 80px rgba(0, 0, 0, 0.55);
  }

  .title {
    margin: 0;
    font-size: 26px;
    font-weight: 800;
    letter-spacing: -0.03em;
    color: rgba(255, 255, 255, 0.95);
  }

  .subtitle {
    margin: 10px 0 0 0;
    color: rgba(255, 255, 255, 0.72);
    line-height: 1.5;
  }

  .actions {
    margin-top: 18px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .btn {
    appearance: none;
    border: 0;
    border-radius: 16px;
    padding: 14px 14px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 140ms ease, opacity 140ms ease, background 140ms ease;
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .btn:active {
    transform: translateY(0px);
    opacity: 0.9;
  }

  .btn-primary {
    background: rgba(34, 197, 94, 0.95);
    color: #07160d;
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.12);
    color: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(255, 255, 255, 0.14);
  }

  @media (min-width: 640px) {
    .actions {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (prefers-reduced-motion: reduce) {
    #mode-selector {
      transition: none;
    }
    .btn {
      transition: none;
    }
  }
</style>

